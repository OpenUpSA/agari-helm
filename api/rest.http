# Test users from AGARI realm
@username = testuser
# @username = orgadmin
# @username = orgcontrib
# @username = orgviewer
# @username = projectadmin
# @username = projectcontrib
# @username = projectviewer
@password = password123
@realm = agari
@query_realm = agari
@client_id = song-client
@client_secret = hVRE3H3WO5E7cysTo7KC0qJBeBWXb4tH

### TEST with admin-cli (should always work)
# @name adminLogin
# POST http://keycloak.local/realms/{{realm}}/protocol/openid-connect/token
# Content-Type: application/x-www-form-urlencoded

# username={{username}}
# &password={{password}}
# &grant_type=password
# &client_id=admin-cli

### LOGIN with project client

# @name login
POST http://keycloak.local/realms/{{realm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

username={{username}}
&password={{password}}
&grant_type=password
&client_id={{client_id}}
&client_secret={{client_secret}}






###

@token = {{login.response.body.access_token}}
@refresh_token = {{login.response.body.refresh_token}}

### LOGOUT

POST http://keycloak.local/realms/{{realm}}/protocol/openid-connect/logout
Content-Type: application/x-www-form-urlencoded

client_id={{client_id}}
&client_secret={{client_secret}}
&refresh_token={{refresh_token}}

### SONG API Tests

### Get all studies (works!)
GET http://song.local/studies/all
Authorization: Bearer {{token}}

### Get study by ID
GET http://song.local/studies/study1
Authorization: Bearer {{token}}

### Create a new study (requires admin/contributor role)
### Try different POST endpoints
POST http://song.local/studies/study1/
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "studyId": "study1",
  "name": "AGARI Test Study", 
  "description": "Test study for RBAC validation",
  "organization": "NICD",
  "info": {
    "projectType": "genomics",
    "region": "South Africa"
  }
}

### Get analyses for a study
GET http://song.local/studies/study1/analysis/
Authorization: Bearer {{token}}

### Submit analysis metadata (requires contributor role)
POST http://song.local/submit/study1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "studyId": "study1",
  "analysisType": {
    "name": "sequencingRead",
    "version": 1
  },
  "samples": [
    {
      "submitterSampleId": "SA001",
      "sampleType": "Total DNA",
      "matchedNormalSubmitterSampleId": null,
      "specimen": {
        "submitterSpecimenId": "SP001",
        "specimenType": "Normal",
        "specimenTissueSource": "Blood derived",
        "tumourNormalDesignation": "Normal"
      },
      "donor": {
        "submitterDonorId": "D001",
        "gender": "Male"
      }
    }
  ],
  "files": [
    {
      "fileName": "sample_R1.fastq.gz",
      "fileType": "FASTQ",
      "fileSize": 1024000,
      "fileMd5sum": "d41d8cd98f00b204e9800998ecf8427e",
      "fileAccess": "open",
      "dataType": "Sequencing Reads"
    }
  ],
  "experiment": {
    "libraryStrategy": "WGS",
    "pairedEnd": true,
    "aligned": false
  }
}


}


### Verify the submitted analysis
GET http://song.local/studies/study1/analysis/dbeefa33-4abb-4da1-aefa-334abbbda143
Authorization: Bearer {{token}}

### Test Score API connection
GET http://score.local/download/ping
Authorization: Bearer {{token}}

### Test uploading a file to Score
POST http://score.local/upload/study1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "analysisId": "dbeefa33-4abb-4da1-aefa-334abbbda143",
  "files": [
    {
      "fileName": "sample_R1.fastq.gz",
      "fileType": "FASTQ",
      "fileSize": 1024000,
      "fileMd5sum": "d41d8cd98f00b204e9800998ecf8427e",
      "fileAccess": "open"
    }
  ]
}

eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJPZ0tPVWZOWjMyUEYxdkcxRXo2aXg1XzY4U0V6cFlwUHA5UVpxZmcyY1o0In0.eyJleHAiOjE3NTUwNzg3NTksImlhdCI6MTc1NTA3ODQ1OSwianRpIjoib25ydHJvOmQ4NjQ1NTc2LTQ4MDEtZjBmYS1lMTQyLWIxODhlMDA5M2MxYiIsImlzcyI6Imh0dHA6Ly9rZXljbG9hay5sb2NhbC9yZWFsbXMvYWdhcmkiLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiYTVmOTM3Y2UtMjkyZi00YzExLWFiYTItYzljYjQwZTJhYjRmIiwidHlwIjoiQmVhcmVyIiwiYXpwIjoic29uZy1jbGllbnQiLCJzaWQiOiI2MTE2ZjRmMy1jN2QwLTRhNmUtOTMyZS0zNTQyMzM3NDBlODUiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbInNvbmcuUkVBRCIsIlNUVURZLnN0dWR5MS5XUklURSIsImNvbnRyaWJ1dG9yIiwic29uZy5XUklURSIsInNjb3JlLldSSVRFIl19LCJyZXNvdXJjZV9hY2Nlc3MiOnsiYWNjb3VudCI6eyJyb2xlcyI6WyJtYW5hZ2UtYWNjb3VudCIsIm1hbmFnZS1hY2NvdW50LWxpbmtzIl19fSwic2NvcGUiOiJwcm9maWxlIGVtYWlsIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJuYW1lIjoiVGVzdCBVc2VyIiwiY29udGV4dCI6eyJzY29wZSI6WyJzb25nLlJFQUQiLCJTVFVEWS5zdHVkeTEuV1JJVEUiLCJjb250cmlidXRvciIsInNvbmcuV1JJVEUiLCJzY29yZS5XUklURSJdfSwicHJlZmVycmVkX3VzZXJuYW1lIjoidGVzdHVzZXIiLCJnaXZlbl9uYW1lIjoiVGVzdCIsImZhbWlseV9uYW1lIjoiVXNlciIsImVtYWlsIjoidGVzdEBhZ2FyaS5vcmcifQ.b8DB9cUcLz7P0-hGtZojl96RTDI24pqu00Oc-6pPr4CeTLCZlwZXYQjjVmp14ne6Guwyrwk4Eh9s1DiJZxJ2VlJah9iQr-9aZvTlRKEBLoUGIlFxO_2QPjjQNtjgOuKVNGGmlUytRKuy6H84WQEIkLTweHiunO0pexh8n6JE2S1MrMEJk-MDQMP0AJ55eHv9Z7cVz1Xyq95VHI9jGpCHkFAMyvg4pMmDS5vX3CFJymNNnP8k2Ie3OeJJEA2Bz3g9YuDD4v-l7R4Oc0-4qfBCZwiv43dLNZqloqUl-CQEJ5ij9PqhkdGFIKX4aqkfnmbm_KuC8h5ac9O4lf88UMXJNw